import os
from celery import Celery
import smtplib
from email.mime.text import MIMEText
from datetime import datetime

# Initialize Celery
celery = Celery('mails', broker='pyamqp://myuser:mypassword@35.171.162.220//')

def ensure_log_file_exists(file_path):
    """Ensure that the log file exists and has the correct permissions."""
    if not os.path.isfile(file_path):
        # Create the log file if it doesn't exist
        with open(file_path, 'w'):
            pass

    # Set permissions to ensure it's writable
#    os.chmod(file_path, stat.S_IRUSR | stat.S_IWUSR | stat.S_IRGRP | stat.S_IROTH)
    os.chmod(file_path, stat.S_IRUSR | stat.S_IWUSR | stat.S_IRGRP | stat.S_IROTH)

@celery.task
def send_email(recipient):
    import smtplib
    from email.mime.text import MIMEText
    msg = MIMEText('This is a test email.')
    msg['Subject'] = 'Test Email'
    msg['From'] = 'divine2142@gmail.com'
    msg['To'] = recipient

    try:
        with smtplib.SMTP('smtp.gmail.com', 587) as server:
            server.starttls()  # Upgrade to a secure connection
            server.login('divine2142@gmail.com', 'xtlcalmpcbjhfbnq')  # Log in to your Gmail account
            server.sendmail(msg['From'], [msg['To']], msg.as_string())  # Send the email
        print('Email sent successfully!')
    except Exception as e:
        print(f'Failed to send email: {e}')

send_email('kenedinma@gmail.com')

@celery.task
def log_time():
    log_file_path = '/var/log/messaging_system.log'
    ensure_log_file_exists(log_file_path)

    with open(log_file_path, 'a') as f:
        f.write(f'{datetime.now()}\n')
